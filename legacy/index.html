<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Essay Architect</title>

    <!-- App Favicon (Matches the 'E' Logo) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%231c1917'/><text x='50' y='70' fill='white' font-family='serif' font-weight='900' font-size='80' text-anchor='middle'>E</text></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400&family=Inter:wght@300;400;500;700&display=swap"
        rel="stylesheet">

    <!-- React & ReactDOM (via ESM) -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "lucide-react": "https://esm.sh/lucide-react@0.263.1"
            }
        }
    </script>

    <!-- Babel for in-browser JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        :root {
            --font-serif: 'Playfair Display', serif;
            --font-sans: 'Inter', sans-serif;
        }

        body {
            font-family: var(--font-sans);
            background-color: #f4f1ea;
        }

        .font-serif {
            font-family: var(--font-serif);
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f4f1ea;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #e7e5e4;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a8a29e;
        }

        /* Animation Utilities */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideInFromBottom {
            from {
                transform: translateY(10px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideInFromRight {
            from {
                transform: translateX(20px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes zoomIn {
            from {
                transform: scale(0.95);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .animate-in {
            animation-duration: 0.4s;
            animation-fill-mode: both;
        }

        .fade-in {
            animation-name: fadeIn;
        }

        .slide-in-from-bottom-2 {
            animation-name: slideInFromBottom;
        }

        .slide-in-from-right-8 {
            animation-name: slideInFromRight;
        }

        .zoom-in {
            animation-name: zoomIn;
        }

        /* Utility for magazine layout */
        .column-count-1 {
            column-count: 1;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import {
            BookOpen, PenTool, CheckCircle, HelpCircle, ChevronRight, ChevronLeft,
            RefreshCw, Clock, AlignLeft, Award, AlertCircle, Copy, RotateCcw, X,
            Info, Sparkles, GraduationCap, Feather, ArrowRight, Quote, Type, Wand2, MessageSquare, Settings, Zap
        } from 'lucide-react';

        // --- API Helper ---
        const callGemini = async (prompt, systemInstruction = "") => {
            // Retrieve key from LocalStorage for local usage
            const apiKey = localStorage.getItem("gemini_api_key") || ""; 
            
            if (!apiKey) {
                alert("API Key missing! Please click the Settings (Gear) icon in the top right and enter your Google Gemini API Key to use AI features.");
                throw new Error("API Key is required.");
            }

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] }
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 400 || response.status === 403) {
                        throw new Error("Invalid API Key. Please check your settings.");
                    }
                    throw new Error(`API Error: ${response.status}`);
                }
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || null;
            } catch (error) {
                console.error("Gemini API Call Failed:", error);
                throw error;
            }
        };

        // --- Components ---

        const SettingsModal = ({ onClose }) => {
            const [key, setKey] = useState(localStorage.getItem('gemini_api_key') || '');

            const handleSave = () => {
                localStorage.setItem('gemini_api_key', key.trim());
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-stone-900/90 z-[100] flex items-center justify-center p-4 animate-in fade-in duration-300">
                    <div className="bg-[#f4f1ea] border-2 border-stone-900 shadow-[8px_8px_0px_0px_rgba(255,255,255,1)] max-w-md w-full p-8 relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-stone-500 hover:text-stone-900"><X size={24} /></button>
                        <h2 className="font-serif font-black text-2xl mb-4 text-stone-900">Settings</h2>
                        <div className="space-y-4">
                            <div>
                                <label className="text-xs font-bold uppercase tracking-widest text-stone-500 mb-2 block">Gemini API Key</label>
                                <input 
                                    type="password" 
                                    value={key}
                                    onChange={(e) => setKey(e.target.value)}
                                    className="w-full p-3 border-2 border-stone-300 focus:border-stone-900 outline-none text-stone-900 bg-white"
                                    placeholder="Paste your API key here..."
                                />
                                <p className="text-[10px] text-stone-500 mt-2 font-medium leading-relaxed">
                                    Required for AI features. Get a free key at <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" className="underline hover:text-stone-900 font-bold">Google AI Studio</a>.
                                    <br/>Key is stored locally in your browser.
                                </p>
                            </div>
                            <button onClick={handleSave} className="w-full bg-stone-900 text-white py-3 font-bold uppercase tracking-widest hover:bg-yellow-400 hover:text-stone-900 transition-colors border-2 border-stone-900">
                                Save Settings
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const RefineModal = ({ isOpen, onClose, originalText, onAccept }) => {
            const [suggestion, setSuggestion] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            useEffect(() => {
                if (isOpen && originalText) {
                    generateSuggestion();
                }
            }, [isOpen, originalText]);

            const generateSuggestion = async () => {
                setLoading(true);
                setError(null);
                setSuggestion(null);
                try {
                    const prompt = `Rewrite the following sentence to be formal and concise, suitable for an IELTS/PTE essay, using 10th-grade reading level vocabulary (clear and accessible). Do not change the meaning. Return ONLY the rewritten sentence.\n\nOriginal: "${originalText}"`;
                    const result = await callGemini(prompt);
                    setSuggestion(result ? result.trim() : "Could not generate suggestion.");
                } catch (err) {
                    setError(err.message || "Failed to connect to the editor AI.");
                } finally {
                    setLoading(false);
                }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-stone-900/80 z-[100] flex items-center justify-center p-4 animate-in fade-in duration-300">
                    <div className="bg-white border-2 border-stone-900 shadow-[8px_8px_0px_0px_rgba(250,204,21,1)] max-w-lg w-full p-6 relative">
                        <button onClick={onClose} className="absolute top-2 right-2 hover:bg-stone-100 p-1 rounded-full"><X size={20} /></button>
                        
                        <div className="flex items-center gap-2 mb-4 border-b-2 border-stone-100 pb-2">
                            <Sparkles className="text-yellow-500" size={20} />
                            <h3 className="font-serif font-black text-xl">AI Refiner</h3>
                        </div>

                        <div className="space-y-4">
                            <div>
                                <p className="text-[10px] font-bold uppercase text-stone-400 mb-1">Original</p>
                                <p className="text-stone-600 bg-stone-50 p-3 italic border-l-2 border-stone-300 text-sm">{originalText}</p>
                            </div>

                            <div>
                                <p className="text-[10px] font-bold uppercase text-stone-400 mb-1">Suggestion</p>
                                {loading ? (
                                    <div className="flex items-center gap-2 text-stone-400 text-sm p-3 bg-stone-50 animate-pulse">
                                        <Wand2 size={14} className="animate-spin" /> Drafting improvement...
                                    </div>
                                ) : error ? (
                                    <p className="text-red-500 text-sm p-3 bg-red-50">{error}</p>
                                ) : (
                                    <p className="text-stone-900 font-medium p-3 bg-yellow-50 border-l-2 border-yellow-400 text-lg font-serif">{suggestion}</p>
                                )}
                            </div>
                        </div>

                        <div className="flex gap-3 mt-6">
                            <button onClick={onClose} className="flex-1 py-3 text-stone-500 font-bold uppercase text-xs hover:text-stone-900">Keep Original</button>
                            <button 
                                onClick={() => { onAccept(suggestion); onClose(); }}
                                disabled={loading || !suggestion || error}
                                className="flex-1 bg-stone-900 text-white py-3 font-bold uppercase text-xs tracking-wider hover:bg-yellow-400 hover:text-stone-900 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                            >
                                Use Suggestion
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const ExaminerModal = ({ isOpen, onClose, essayText }) => {
            const [feedback, setFeedback] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [examType, setExamType] = useState(null); // 'ielts' or 'pte'

            // Reset state when modal opens
            useEffect(() => {
                if (isOpen) {
                    setFeedback(null);
                    setExamType(null);
                    setError(null);
                }
            }, [isOpen]);

            const getFeedback = async (type) => {
                setLoading(true);
                setError(null);
                setFeedback(null);
                
                try {
                    let prompt = "";
                    // Calculate word count locally to prevent AI hallucination
                    const wordCount = essayText.trim().split(/\s+/).filter(word => word.length > 0).length;
                    
                    if (type === 'ielts') {
                        prompt = `Act as a strict IELTS Examiner. Analyze the following essay based on the official 4 marking criteria: Task Response (TR), Coherence & Cohesion (CC), Lexical Resource (LR), and Grammatical Range & Accuracy (GRA). 
                        
                        METADATA:
                        - Exact Word Count: ${wordCount} words. (Use this for length-based penalties if under 250 words).

                        Return strictly valid JSON with this structure: 
                        { 
                            "overallScore": "number (0-9 in 0.5 steps)", 
                            "breakdown": { "TR": "number", "CC": "number", "LR": "number", "GRA": "number" }, 
                            "critique": "string (A concise paragraph analyzing the essay against these 4 criteria)", 
                            "strengths": "string (One specific thing done well)",
                            "weakness": "string (One specific area for improvement. If score is 9.0, return null)"
                        }.
                        
                        Essay:
                        ${essayText}`;
                    } else {
                        // PTE Prompt - Updated to 7 Official Traits
                        prompt = `Act as a strict PTE Academic Examiner. Analyze the following essay based on the official 7 scoring traits for the 'Write Essay' task.
                        
                        METADATA:
                        - Exact Word Count: ${wordCount} words. 
                        - CRITICAL: Use this word count for the 'Form' score.
                        
                        SCORING RULES:
                        1. Content (0-3): 3=Adequate, 0=Irrelevant.
                        2. Form (0-2): 200-300 words = 2. 120-199 or 301-380 = 1. <120 or >380 = 0.
                        3. Structure (0-2): Development and Coherence.
                        4. Grammar (0-2): 2=Consistent/Correct, 1=Some errors but clear, 0=Fails communication.
                        5. Linguistic (0-2): General Linguistic Range (Precision/Emphasis).
                        6. Vocab (0-2): Vocabulary Range (Variety/Synonyms).
                        7. Spelling (0-2): 2=No errors. 1=One error. 0=More than one error.

                        Return strictly valid JSON with this structure:
                        {
                            "overallScore": "number (10-90 integer)",
                            "breakdown": { 
                                "Content": "score (0-3)", 
                                "Form": "score (0-2)", 
                                "Structure": "score (0-2)", 
                                "Grammar": "score (0-2)", 
                                "Linguistic": "score (0-2)",
                                "Vocab": "score (0-2)", 
                                "Spelling": "score (0-2)" 
                            },
                            "critique": "string (A concise paragraph analyzing the essay based on PTE standards)",
                            "strengths": "string (One specific thing done well)",
                            "weakness": "string (One specific area for improvement. If score is 90, return null)"
                        }

                        Essay:
                        ${essayText}`;
                    }

                    const resultText = await callGemini(prompt, "You are a helpful API that returns strictly valid JSON.");
                    // Attempt to parse JSON (cleaning potential markdown fences)
                    const cleanJson = resultText.replace(/```json|```/g, '').trim();
                    const data = JSON.parse(cleanJson);
                    setFeedback(data);
                } catch (err) {
                    console.error(err);
                    setError(err.message || "The examiner is currently unavailable. Please try again.");
                } finally {
                    setLoading(false);
                }
            };

            const handleSelectExam = (type) => {
                setExamType(type);
                getFeedback(type);
            };

            const getFullLabel = (key) => {
                const labels = {
                    // IELTS
                    TR: "Task Response",
                    CC: "Coherence & Cohesion",
                    LR: "Lexical Resource",
                    GRA: "Grammar Range",
                    // PTE
                    Content: "Content Quality",
                    Form: "Length/Form",
                    Structure: "Structure & Coherence",
                    Grammar: "Grammar",
                    Linguistic: "General Linguistic Range",
                    Vocab: "Vocabulary Range",
                    Spelling: "Spelling"
                };
                return labels[key] || key;
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-stone-900/90 z-[100] flex items-center justify-center p-4 animate-in fade-in duration-300">
                    <div className="bg-[#f4f1ea] border-2 border-stone-900 shadow-[8px_8px_0px_0px_rgba(255,255,255,1)] max-w-2xl w-full max-h-[90vh] overflow-y-auto relative custom-scrollbar">
                        <button onClick={onClose} className="absolute top-4 right-4 text-stone-500 hover:text-stone-900"><X size={24} /></button>

                        <div className="bg-stone-900 p-6 text-white mb-6">
                            <h2 className="font-serif font-black text-3xl flex items-center gap-3">
                                <GraduationCap size={32} className="text-yellow-400" />
                                Examiner's Report
                            </h2>
                        </div>

                        <div className="p-8 pt-0 space-y-6">
                            {!examType ? (
                                <div className="text-center py-8">
                                    <h3 className="font-serif font-bold text-2xl text-stone-900 mb-2">Select Evaluation Standard</h3>
                                    <p className="text-stone-500 mb-8 text-sm">Choose the exam criteria you wish to be scored against.</p>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <button 
                                            onClick={() => handleSelectExam('ielts')}
                                            className="group relative p-6 border-2 border-stone-200 hover:border-stone-900 hover:bg-white bg-stone-50 transition-all text-left"
                                        >
                                            <div className="absolute top-0 left-0 w-full h-1 bg-red-600 scale-x-0 group-hover:scale-x-100 transition-transform origin-left"></div>
                                            <span className="text-xs font-black uppercase tracking-widest text-stone-400 group-hover:text-red-600 mb-2 block">Band 0-9</span>
                                            <span className="text-3xl font-black font-serif text-stone-900 block mb-1">IELTS</span>
                                            <span className="text-xs text-stone-500">Academic & General Training</span>
                                        </button>

                                        <button 
                                            onClick={() => handleSelectExam('pte')}
                                            className="group relative p-6 border-2 border-stone-200 hover:border-stone-900 hover:bg-white bg-stone-50 transition-all text-left"
                                        >
                                            <div className="absolute top-0 left-0 w-full h-1 bg-blue-600 scale-x-0 group-hover:scale-x-100 transition-transform origin-left"></div>
                                            <span className="text-xs font-black uppercase tracking-widest text-stone-400 group-hover:text-blue-600 mb-2 block">Score 10-90</span>
                                            <span className="text-3xl font-black font-serif text-stone-900 block mb-1">PTE</span>
                                            <span className="text-xs text-stone-500">Pearson Test of English</span>
                                        </button>
                                    </div>
                                </div>
                            ) : loading ? (
                                <div className="text-center py-12 space-y-4">
                                    <div className="w-16 h-16 border-4 border-stone-200 border-t-stone-900 rounded-full animate-spin mx-auto"></div>
                                    <p className="font-serif text-xl text-stone-600 animate-pulse">
                                        {examType === 'ielts' ? "Checking Task Response & Cohesion..." : "Analyzing Content, Form & Grammar..."}
                                    </p>
                                </div>
                            ) : error ? (
                                <div className="p-4 bg-red-100 border border-red-500 text-red-700 text-center">
                                    {error}
                                    <button onClick={() => setExamType(null)} className="block mx-auto mt-2 text-xs font-bold underline">Try Again</button>
                                </div>
                            ) : feedback ? (
                                <>
                                    <div className="flex flex-col md:flex-row items-start md:items-center justify-between border-b-2 border-stone-200 pb-6 gap-6">
                                        <div>
                                            <div className="flex items-center gap-2 mb-1">
                                                <span className={`text-[10px] font-black uppercase tracking-widest text-white px-2 py-0.5 ${examType === 'ielts' ? 'bg-red-600' : 'bg-blue-600'}`}>
                                                    {examType === 'ielts' ? 'IELTS' : 'PTE'}
                                                </span>
                                                <p className="text-xs font-bold uppercase tracking-widest text-stone-500">Overall Score</p>
                                            </div>
                                            <div className="text-6xl font-black font-serif text-stone-900">{feedback.overallScore}</div>
                                        </div>

                                        {/* Dynamic Score Breakdown Grid */}
                                        <div className="flex flex-wrap gap-2 md:gap-4 w-full md:w-auto bg-stone-50 p-4 border border-stone-200 justify-center md:justify-end">
                                            {feedback.breakdown && Object.entries(feedback.breakdown).map(([key, score]) => (
                                                <div key={key} className="text-center group relative cursor-help min-w-[60px]">
                                                    <div className="text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-1 truncate max-w-[80px] mx-auto" title={key}>{key}</div>
                                                    <div className="font-serif font-bold text-xl text-stone-900">{score}</div>
                                                    <span className="invisible group-hover:visible absolute bottom-full left-1/2 -translate-x-1/2 bg-stone-900 text-white text-[10px] p-2 rounded w-32 mb-2 z-50 pointer-events-none">
                                                        {getFullLabel(key)}
                                                    </span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="mt-6 space-y-4">
                                        <div>
                                            <p className="text-xs font-bold uppercase tracking-widest text-stone-500 mb-2">Examiner's Critique</p>
                                            <p className="text-stone-700 leading-relaxed whitespace-pre-line border-l-2 border-stone-900 pl-4">{feedback.critique}</p>
                                        </div>

                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <p className="text-xs font-bold uppercase tracking-widest text-green-600 mb-2">Key Strength</p>
                                                <p className="text-sm font-medium text-stone-600 bg-green-50 p-3 border border-green-200">{feedback.strengths}</p>
                                            </div>
                                            {feedback.weakness && (
                                                <div>
                                                    <p className="text-xs font-bold uppercase tracking-widest text-red-600 mb-2">Key Weakness</p>
                                                    <p className="text-sm font-medium text-stone-600 bg-red-50 p-3 border border-red-200">{feedback.weakness}</p>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    <div className="bg-yellow-50 p-4 border-l-4 border-yellow-400 text-sm text-stone-600 italic mt-4">
                                        Disclaimer: This is an AI estimation based on public {examType.toUpperCase()} descriptors. Official results may vary.
                                    </div>
                                    
                                    <button onClick={() => setExamType(null)} className="text-center w-full text-xs font-bold uppercase tracking-widest text-stone-400 hover:text-stone-900 mt-2">
                                        Start New Evaluation
                                    </button>
                                </>
                            ) : null}

                            <button onClick={onClose} className="w-full bg-stone-900 text-white py-4 font-bold uppercase tracking-widest hover:bg-stone-700 transition-colors">
                                Close Report
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const VocabularyPill = ({ words, onSelect }) => {
            return (
                <div className="flex flex-wrap gap-3 mt-4 animate-in fade-in slide-in-from-bottom-2 duration-500">
                    {words.map((word, idx) => (
                        <button
                            key={idx}
                            onClick={(e) => {
                                e.preventDefault();
                                if (onSelect) onSelect(word);
                            }}
                            className="group relative inline-flex items-center gap-1.5 text-xs font-bold uppercase tracking-wide bg-white border border-stone-900 text-stone-900 px-4 py-2 hover:bg-stone-900 hover:text-white transition-all duration-200 shadow-[2px_2px_0px_0px_rgba(28,25,23,1)] hover:shadow-none hover:translate-x-[2px] hover:translate-y-[2px]"
                            title="Click to insert into text box"
                        >
                            <Sparkles size={10} className="opacity-0 group-hover:opacity-100 transition-opacity absolute left-1" />
                            <span className="group-hover:pl-2 transition-all">{word}</span>
                        </button>
                    ))}
                </div>
            );
        };

        const TourTooltip = ({ stepIndex, currentStep, onNext, onSkip, text, position = "bottom" }) => {
            if (currentStep !== stepIndex) return null;

            const positionClasses = {
                bottom: "top-full left-1/2 -translate-x-1/2 mt-6",
                top: "bottom-full left-1/2 -translate-x-1/2 mb-6",
                left: "right-full top-1/2 -translate-y-1/2 mr-6",
                right: "left-full top-1/2 -translate-y-1/2 ml-6",
                bottomLeft: "top-full right-0 mt-6",
                bottomRight: "top-full left-0 mt-6",
            };

            return (
                <div className={`absolute z-50 w-72 bg-yellow-400 border-2 border-stone-900 text-stone-900 shadow-[8px_8px_0px_0px_rgba(28,25,23,1)] p-0 ${positionClasses[position] || positionClasses.bottom} animate-in fade-in zoom-in duration-300`}>
                    <div className={`absolute bg-stone-900
                    ${position === 'bottom' ? '-top-6 left-1/2 w-0.5 h-6' : ''}
                    ${position === 'top' ? '-bottom-6 left-1/2 w-0.5 h-6' : ''}
                    ${position === 'left' ? '-right-6 top-1/2 h-0.5 w-6' : ''}
                    ${position === 'right' ? '-left-6 top-1/2 h-0.5 w-6' : ''}
                    ${position === 'bottomLeft' ? '-top-6 right-6 w-0.5 h-6' : ''}
                    ${position === 'bottomRight' ? '-top-6 left-6 w-0.5 h-6' : ''}
                `} />

                    <div className="relative z-10 p-5">
                        <div className="flex gap-3 mb-3 items-start">
                            <div className="bg-stone-900 text-white w-6 h-6 flex items-center justify-center shrink-0 text-xs font-bold border border-stone-900">
                                {stepIndex + 1}
                            </div>
                            <p className="text-sm font-bold font-serif leading-tight">{text}</p>
                        </div>

                        <div className="flex justify-between items-center pt-3 border-t border-stone-900/20 mt-1">
                            <button onClick={onSkip} className="text-stone-700 hover:text-stone-900 text-xs font-bold uppercase tracking-wider underline decoration-1 underline-offset-2">End Tour</button>
                            <div className="flex items-center gap-3">
                                <span className="text-[10px] text-stone-600 font-mono">{stepIndex + 1}/4</span>
                                <button
                                    onClick={onNext}
                                    className="bg-stone-900 text-white px-4 py-1.5 text-xs font-bold uppercase tracking-wider hover:bg-white hover:text-stone-900 transition-colors border border-stone-900"
                                >
                                    {stepIndex === 3 ? "Finish" : "Next"}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const AboutModal = ({ onClose }) => (
            <div 
                onClick={onClose}
                className="fixed inset-0 bg-stone-900/90 z-[100] flex items-center justify-center p-4 animate-in fade-in duration-300 cursor-pointer"
            >
                <div 
                    onClick={(e) => e.stopPropagation()}
                    className="bg-[#f4f1ea] border-2 border-stone-900 shadow-[8px_8px_0px_0px_rgba(255,255,255,1)] max-w-lg w-full overflow-hidden relative transform transition-all scale-100 cursor-default"
                >

                    {/* Editorial Header */}
                    <div className="bg-stone-900 p-8 text-white relative overflow-hidden">
                        <div className="absolute top-0 right-0 p-8 opacity-10">
                            <Type size={120} />
                        </div>

                        <button
                            onClick={onClose}
                            className="absolute top-4 right-4 text-white hover:text-yellow-400 transition-colors"
                        >
                            <X size={24} strokeWidth={3} />
                        </button>

                        <div className="relative z-10">
                            <span className="inline-block px-2 py-1 bg-yellow-400 text-stone-900 text-[10px] font-black uppercase tracking-widest mb-2">The Manual</span>
                            <h2 className="text-4xl font-serif font-black tracking-tight leading-none mb-1">Essay<br />Architect</h2>
                            <p className="text-stone-400 text-sm font-mono mt-2 border-t border-stone-700 pt-2 inline-block">Est. 2025 â€¢ IELTS & PTE Edition</p>
                        </div>
                    </div>

                    <div className="p-8 space-y-6">
                        <div className="font-serif text-xl leading-relaxed text-stone-800 border-l-4 border-yellow-400 pl-4 italic">
                            "Structure is not just a framework; it is the skeleton upon which your ideas must hang."
                        </div>

                        <p className="text-stone-600 font-sans leading-relaxed text-sm">
                            This tool combines rigid structure with modern AI to help you achieve Band 9/90.
                        </p>

                        <div className="grid grid-cols-1 gap-3">
                            <div className="flex items-center gap-3 p-3 border border-stone-200 bg-white">
                                <div className="bg-stone-900 text-white p-2 shrink-0"><Wand2 size={16} /></div>
                                <div>
                                    <p className="font-bold text-stone-900 uppercase text-[10px] tracking-wider">AI Autocomplete</p>
                                    <p className="text-[10px] text-stone-500 font-serif">Stuck? Click 'Complete' to generate the perfect next sentence.</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-3 p-3 border border-stone-200 bg-white">
                                <div className="bg-stone-900 text-white p-2 shrink-0"><Sparkles size={16} /></div>
                                <div>
                                    <p className="font-bold text-stone-900 uppercase text-[10px] tracking-wider">AI Refiner</p>
                                    <p className="text-[10px] text-stone-500 font-serif">Rewrite sentences for better academic flow and vocabulary.</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-3 p-3 border border-stone-200 bg-white">
                                <div className="bg-stone-900 text-white p-2 shrink-0"><GraduationCap size={16} /></div>
                                <div>
                                    <p className="font-bold text-stone-900 uppercase text-[10px] tracking-wider">AI Examiner</p>
                                    <p className="text-[10px] text-stone-500 font-serif">Get instant scores for IELTS (Band 0-9) or PTE (10-90).</p>
                                </div>
                            </div>
                             <div className="flex items-center gap-3 p-3 border border-stone-200 bg-white">
                                <div className="bg-stone-900 text-white p-2 shrink-0"><Settings size={16} /></div>
                                <div>
                                    <p className="font-bold text-stone-900 uppercase text-[10px] tracking-wider">BYO Key</p>
                                    <p className="text-[10px] text-stone-500 font-serif">Securely use your own Gemini API key via Settings.</p>
                                </div>
                            </div>
                        </div>

                        <button
                            onClick={onClose}
                            className="w-full bg-stone-900 text-white py-4 font-bold uppercase tracking-widest hover:bg-yellow-500 hover:text-stone-900 transition-colors border-2 border-transparent hover:border-stone-900"
                        >
                            Start The Edition
                        </button>
                    </div>
                </div>
            </div>
        );

        const StepWizard = ({ currentStep, setCurrentStep, essay, handleInputChange, tourProps, topic }) => {
            const steps = [
                { id: 'intro', title: 'The Introduction', subtitle: 'Set the Stage', icon: "I" },
                { id: 'body1', title: 'The First Argument', subtitle: 'Point, Explain, Evidence', icon: "II" },
                { id: 'body2', title: 'The Second Argument', subtitle: 'Reinforce your Stance', icon: "III" },
                { id: 'conclusion', title: 'The Conclusion', subtitle: 'The Final Verdict', icon: "IV" },
            ];

            const currentStepData = steps[currentStep];
            const [refineModal, setRefineModal] = useState({ isOpen: false, text: '', section: '', field: '' });
            const [generatingField, setGeneratingField] = useState(null);

            const handleVocabularyInsert = (section, field, text) => {
                const currentVal = essay[section][field] || '';
                const spacer = currentVal.length > 0 && !currentVal.match(/\s$/) ? ' ' : '';
                const newVal = currentVal + spacer + text;
                handleInputChange(section, field, newVal);
            };

            const openRefine = (section, field, text) => {
                if(!text || text.trim().length < 5) return;
                setRefineModal({ isOpen: true, text, section, field });
            };

            const handleRefineAccept = (newText) => {
                handleInputChange(refineModal.section, refineModal.field, newText);
            };

            const handleAutocomplete = async (section, field, currentText) => {
                setGeneratingField(`${section}-${field}`);
                try {
                    // Build sophisticated context based on the entire essay flow so far
                    let contextInfo = "";
                    
                    // Helper to get text safely
                    const getTxt = (sec, fld) => essay[sec]?.[fld] || "";

                    if (section === 'intro') {
                        if (field === 'thesis') {
                            contextInfo = `Preceding Paraphrase: "${getTxt('intro', 'paraphrase')}"`;
                        }
                    } 
                    else if (section === 'body1') {
                        // For Body 1, knowing the thesis is crucial
                        const thesis = getTxt('intro', 'thesis');
                        
                        if (field === 'topicSentence') {
                            contextInfo = `Essay Thesis: "${thesis}"`; 
                        } else if (field === 'explanation') {
                            contextInfo = `Topic Sentence: "${getTxt('body1', 'topicSentence')}"`;
                        } else if (field === 'example') {
                            contextInfo = `Argument Context: "${getTxt('body1', 'topicSentence')} ${getTxt('body1', 'explanation')}"`;
                        } else if (field === 'concluding') {
                            contextInfo = `Argument Context: "${getTxt('body1', 'topicSentence')} ${getTxt('body1', 'explanation')} ${getTxt('body1', 'example')}"`;
                        }
                    } 
                    else if (section === 'body2') {
                        // For Body 2, we need Thesis AND Body 1 to determine if it's a "Furthermore" or "However" paragraph
                        const thesis = getTxt('intro', 'thesis');
                        const body1Topic = getTxt('body1', 'topicSentence');

                        if (field === 'topicSentence') {
                            contextInfo = `Essay Thesis: "${thesis}".\nPrevious Paragraph Main Point: "${body1Topic}". (Ensure smooth transition/flow from previous paragraph - e.g. using 'However' if contrasting, or 'Furthermore' if supporting).`;
                        } else if (field === 'explanation') {
                            contextInfo = `Topic Sentence: "${getTxt('body2', 'topicSentence')}"`;
                        } else if (field === 'example') {
                            contextInfo = `Argument Context: "${getTxt('body2', 'topicSentence')} ${getTxt('body2', 'explanation')}"`;
                        } else if (field === 'concluding') {
                            contextInfo = `Argument Context: "${getTxt('body2', 'topicSentence')} ${getTxt('body2', 'explanation')} ${getTxt('body2', 'example')}"`;
                        }
                    } 
                    else if (section === 'conclusion') {
                        if (field === 'summary') {
                            // Needs to recap main points
                            contextInfo = `Thesis: "${getTxt('intro', 'thesis')}".\nBody 1 Point: "${getTxt('body1', 'topicSentence')}".\nBody 2 Point: "${getTxt('body2', 'topicSentence')}".`;
                        } else if (field === 'finalThought') {
                            contextInfo = `Preceding Summary: "${getTxt('conclusion', 'summary')}"`;
                        }
                    }

                    const prompt = `Act as an academic essay writer.
                    Essay Topic: "${topic?.question}". 
                    Current Section: ${section.toUpperCase()} - ${field}.
                    
                    ${contextInfo ? `CONTEXT (Must flow logically from this): ${contextInfo}` : ''}
                    
                    Existing text in current box: "${currentText}".
                    
                    Task: Write exactly ONE sentence (or complete the current unfinished sentence) for this specific box. 
                    CRITICAL constraints:
                    1. Ensure logical consistency. If the 'CONTEXT' argues a specific point, your completion MUST support that same point unless the 'Existing text' explicitly starts a transition.
                    2. MAX 1 SENTENCE. Do not write a paragraph.
                    3. LANGUAGE: Use 10th-grade reading level vocabulary (clear, academic, accessible).
                    Return ONLY the text to be added.`;

                    const completion = await callGemini(prompt);
                    if(completion) {
                        const spacer = currentText.length > 0 && !currentText.match(/\s$/) ? ' ' : '';
                        const newVal = currentText + spacer + completion.trim();
                        handleInputChange(section, field, newVal);
                    }
                } catch (err) {
                    alert("Autocomplete failed. Check your API key.");
                } finally {
                    setGeneratingField(null);
                }
            };

            const RefineButton = ({ section, field, text }) => (
                <div className="flex gap-2">
                    <button 
                        onClick={() => handleAutocomplete(section, field, text)}
                        disabled={generatingField === `${section}-${field}`}
                        className="flex items-center gap-1 text-[10px] font-bold uppercase tracking-wider text-blue-600 hover:text-blue-700 disabled:opacity-50 transition-opacity"
                        title="Autocomplete sentence"
                    >
                        {generatingField === `${section}-${field}` ? <Wand2 size={10} className="animate-spin"/> : <Zap size={10} />} Complete
                    </button>
                    <button 
                        onClick={() => openRefine(section, field, text)}
                        disabled={!text || text.length < 5}
                        className="flex items-center gap-1 text-[10px] font-bold uppercase tracking-wider text-yellow-600 hover:text-yellow-700 disabled:opacity-0 transition-opacity"
                    >
                        <Sparkles size={10} /> Refine
                    </button>
                </div>
            );

            return (
                <div className="bg-white border-2 border-stone-900 shadow-[8px_8px_0px_0px_rgba(231,229,228,1)] flex flex-col h-full relative">
                    {refineModal.isOpen && (
                        <RefineModal 
                            isOpen={refineModal.isOpen} 
                            onClose={() => setRefineModal({ ...refineModal, isOpen: false })}
                            originalText={refineModal.text}
                            onAccept={handleRefineAccept}
                        />
                    )}

                    <div className="border-b-2 border-stone-900 p-6 relative bg-[#f4f1ea]">
                        <div className="flex justify-between items-end mb-6">
                            <div>
                                <span className="text-xs font-black uppercase tracking-widest text-stone-500 mb-1 block">Chapter {currentStep + 1}</span>
                                <h2 className="text-3xl font-serif font-black text-stone-900 leading-none">
                                    {currentStepData.title}
                                </h2>
                            </div>

                            <div className="flex gap-0 relative">
                                <button
                                    onClick={() => setCurrentStep(Math.max(0, currentStep - 1))}
                                    disabled={currentStep === 0}
                                    className="w-12 h-12 border-2 border-stone-900 border-r-0 flex items-center justify-center text-stone-900 hover:bg-stone-900 hover:text-white disabled:opacity-20 disabled:hover:bg-transparent disabled:hover:text-stone-900 transition-colors"
                                >
                                    <ChevronLeft size={24} />
                                </button>
                                <button
                                    onClick={() => setCurrentStep(Math.min(3, currentStep + 1))}
                                    disabled={currentStep === 3}
                                    className="w-12 h-12 border-2 border-stone-900 flex items-center justify-center text-stone-900 hover:bg-stone-900 hover:text-white disabled:opacity-20 disabled:hover:bg-transparent disabled:hover:text-stone-900 transition-colors"
                                >
                                    <ChevronRight size={24} />
                                </button>

                                {tourProps && (
                                    <TourTooltip
                                        stepIndex={3}
                                        text="Flip through sections here. Use the 'Complete' and 'Refine' buttons inside to write faster with AI."
                                        position="bottomLeft"
                                        {...tourProps}
                                    />
                                )}
                            </div>
                        </div>

                        <div className="flex items-center w-full h-1 bg-stone-300">
                            {steps.map((step, idx) => (
                                <div key={step.id} className={`h-full flex-1 transition-all duration-300 ${idx <= currentStep ? 'bg-stone-900' : 'bg-transparent'}`}></div>
                            ))}
                        </div>
                    </div>

                    <div className="p-8 flex-1 overflow-y-auto custom-scrollbar bg-white">
                        {currentStep === 0 && (
                            <div className="space-y-10 animate-in slide-in-from-right-8 duration-500">
                                <div className="bg-stone-50 p-6 border-l-4 border-stone-900">
                                    <div className="flex gap-3">
                                        <div className="font-serif font-bold text-4xl text-stone-200 leading-none">"</div>
                                        <div className="text-sm font-serif text-stone-800 italic leading-relaxed">
                                            Your goal is simple: Introduce the topic and state your position clearly. Never copy the question directly!
                                        </div>
                                    </div>
                                </div>

                                <div className="space-y-4">
                                    <div className="flex justify-between items-end border-b-2 border-stone-900 pb-2 mb-4">
                                        <label className="flex flex-col text-lg font-bold font-serif text-stone-900">
                                            <span>1. Paraphrase the Question</span>
                                            <span className="text-[10px] font-sans font-normal text-stone-500 uppercase tracking-widest mt-1">Required â€¢ Use Synonyms</span>
                                        </label>
                                        <RefineButton section="intro" field="paraphrase" text={essay.intro.paraphrase} />
                                    </div>
                                    <textarea
                                        className="w-full p-4 text-stone-900 text-lg leading-relaxed bg-[#f9f9f7] border-0 border-b-2 border-stone-300 focus:border-stone-900 focus:ring-0 focus:bg-yellow-50/30 transition-all min-h-[120px] resize-none placeholder:text-stone-300 placeholder:italic placeholder:font-serif"
                                        placeholder="Start writing here..."
                                        value={essay.intro.paraphrase}
                                        onChange={(e) => handleInputChange('intro', 'paraphrase', e.target.value)}
                                    />
                                    <VocabularyPill
                                        words={['It is widely believed that', 'There is a common perception that', 'Many people argue that']}
                                        onSelect={(word) => handleVocabularyInsert('intro', 'paraphrase', word)}
                                    />
                                </div>

                                <div className="space-y-4 pt-4">
                                    <div className="flex justify-between items-end border-b-2 border-stone-900 pb-2 mb-4">
                                        <label className="flex flex-col text-lg font-bold font-serif text-stone-900">
                                            <span>2. Thesis Statement</span>
                                            <span className="text-[10px] font-sans font-normal text-stone-500 uppercase tracking-widest mt-1">Required â€¢ Your Opinion</span>
                                        </label>
                                        <RefineButton section="intro" field="thesis" text={essay.intro.thesis} />
                                    </div>
                                    <textarea
                                        className="w-full p-4 text-stone-900 text-lg leading-relaxed bg-[#f9f9f7] border-0 border-b-2 border-stone-300 focus:border-stone-900 focus:ring-0 focus:bg-yellow-50/30 transition-all min-h-[120px] resize-none placeholder:text-stone-300 placeholder:italic placeholder:font-serif"
                                        placeholder="I completely agree with this view because..."
                                        value={essay.intro.thesis}
                                        onChange={(e) => handleInputChange('intro', 'thesis', e.target.value)}
                                    />
                                    <VocabularyPill
                                        words={['This essay will discuss', 'I firmly believe that', 'In my opinion']}
                                        onSelect={(word) => handleVocabularyInsert('intro', 'thesis', word)}
                                    />
                                </div>
                            </div>
                        )}

                        {(currentStep === 1 || currentStep === 2) && (
                            <div className="space-y-10 animate-in slide-in-from-right-8 duration-500">
                                <div className="bg-stone-50 p-6 border-l-4 border-stone-900">
                                    <div className="flex gap-3">
                                        <div className="font-serif font-bold text-4xl text-stone-200 leading-none">"</div>
                                        <div className="text-sm font-serif text-stone-800 italic leading-relaxed">
                                            Focus on ONE main idea. Support it with an explanation and a concrete example.
                                        </div>
                                    </div>
                                </div>

                                <div className="space-y-4">
                                    <div className="flex justify-between items-end border-b-2 border-stone-900 pb-2">
                                        <div>
                                            <label className="block text-lg font-bold font-serif text-stone-900">1. Topic Sentence</label>
                                            <p className="text-xs font-mono text-stone-500 uppercase">The Main Idea</p>
                                        </div>
                                        <RefineButton section={`body${currentStep}`} field="topicSentence" text={essay[`body${currentStep}`].topicSentence} />
                                    </div>
                                    <textarea
                                        className="w-full p-4 text-stone-900 text-lg leading-relaxed bg-[#f9f9f7] border-0 border-b-2 border-stone-300 focus:border-stone-900 focus:ring-0 focus:bg-yellow-50/30 transition-all min-h-[80px] resize-none placeholder:text-stone-300 placeholder:italic placeholder:font-serif"
                                        placeholder="Firstly, the main reason for this is..."
                                        value={essay[`body${currentStep}`].topicSentence}
                                        onChange={(e) => handleInputChange(`body${currentStep}`, 'topicSentence', e.target.value)}
                                    />
                                    <VocabularyPill
                                        words={currentStep === 1 ? ['Firstly,', 'To begin with,', 'The primary reason is'] : ['Secondly,', 'Furthermore,', 'In addition,']}
                                        onSelect={(word) => handleVocabularyInsert(`body${currentStep}`, 'topicSentence', word)}
                                    />
                                </div>

                                <div className="space-y-4 pt-4">
                                    <div className="flex justify-between items-end border-b-2 border-stone-900 pb-2">
                                        <div>
                                            <label className="block text-lg font-bold font-serif text-stone-900">2. Explanation</label>
                                            <p className="text-xs font-mono text-stone-500 uppercase">Expand on the point</p>
                                        </div>
                                        <RefineButton section={`body${currentStep}`} field="explanation" text={essay[`body${currentStep}`].explanation} />
                                    </div>
                                    <textarea
                                        className="w-full p-4 text-stone-900 text-lg leading-relaxed bg-[#f9f9f7] border-0 border-b-2 border-stone-300 focus:border-stone-900 focus:ring-0 focus:bg-yellow-50/30 transition-all min-h-[100px] resize-none placeholder:text-stone-300 placeholder:italic placeholder:font-serif"
                                        placeholder="This is because..."
                                        value={essay[`body${currentStep}`].explanation}
                                        onChange={(e) => handleInputChange(`body${currentStep}`, 'explanation', e.target.value)}
                                    />
                                    <VocabularyPill
                                        words={['This means that', 'In other words,', 'This is due to the fact that']}
                                        onSelect={(word) => handleVocabularyInsert(`body${currentStep}`, 'explanation', word)}
                                    />
                                </div>

                                <div className="space-y-4 pt-4">
                                    <div className="flex justify-between items-end border-b-2 border-stone-900 pb-2">
                                        <div>
                                            <label className="block text-lg font-bold font-serif text-stone-900">3. Example</label>
                                            <p className="text-xs font-mono text-stone-500 uppercase">Prove it</p>
                                        </div>
                                        <RefineButton section={`body${currentStep}`} field="example" text={essay[`body${currentStep}`].example} />
                                    </div>
                                    <textarea
                                        className="w-full p-4 text-stone-900 text-lg leading-relaxed bg-[#f9f9f7] border-0 border-b-2 border-stone-300 focus:border-stone-900 focus:ring-0 focus:bg-yellow-50/30 transition-all min-h-[80px] resize-none placeholder:text-stone-300 placeholder:italic placeholder:font-serif"
                                        placeholder="For instance..."
                                        value={essay[`body${currentStep}`].example}
                                        onChange={(e) => handleInputChange(`body${currentStep}`, 'example', e.target.value)}
                                    />
                                    <VocabularyPill
                                        words={['For example,', 'For instance,', 'Take x as an example']}
                                        onSelect={(word) => handleVocabularyInsert(`body${currentStep}`, 'example', word)}
                                    />
                                </div>

                                <div className="space-y-4 pt-4">
                                    <div className="flex justify-between items-end border-b-2 border-stone-900 pb-2">
                                        <div>
                                            <label className="block text-lg font-bold font-serif text-stone-900">4. Link (Optional)</label>
                                            <p className="text-xs font-mono text-stone-500 uppercase">Tie it back</p>
                                        </div>
                                        <RefineButton section={`body${currentStep}`} field="concluding" text={essay[`body${currentStep}`].concluding} />
                                    </div>
                                    <textarea
                                        className="w-full p-4 text-stone-900 text-lg leading-relaxed bg-[#f9f9f7] border-0 border-b-2 border-stone-300 focus:border-stone-900 focus:ring-0 focus:bg-yellow-50/30 transition-all min-h-[80px] resize-none placeholder:text-stone-300 placeholder:italic placeholder:font-serif"
                                        placeholder="Therefore..."
                                        value={essay[`body${currentStep}`].concluding}
                                        onChange={(e) => handleInputChange(`body${currentStep}`, 'concluding', e.target.value)}
                                    />
                                    <VocabularyPill
                                        words={['Therefore,', 'Thus,', 'As a result,']}
                                        onSelect={(word) => handleVocabularyInsert(`body${currentStep}`, 'concluding', word)}
                                    />
                                </div>
                            </div>
                        )}

                        {currentStep === 3 && (
                            <div className="space-y-10 animate-in slide-in-from-right-8 duration-500">
                                <div className="bg-stone-50 p-6 border-l-4 border-stone-900">
                                    <div className="flex gap-3">
                                        <div className="font-serif font-bold text-4xl text-stone-200 leading-none">"</div>
                                        <div className="text-sm font-serif text-stone-800 italic leading-relaxed">
                                            Summarize main points. <span className="bg-stone-900 text-white px-1">DO NOT</span> introduce new arguments here.
                                        </div>
                                    </div>
                                </div>

                                <div className="space-y-4">
                                    <div className="flex justify-between items-end border-b-2 border-stone-900 pb-2">
                                        <div>
                                            <label className="block text-lg font-bold font-serif text-stone-900">1. Summary</label>
                                            <p className="text-xs font-mono text-stone-500 uppercase">The Recap</p>
                                        </div>
                                        <RefineButton section="conclusion" field="summary" text={essay.conclusion.summary} />
                                    </div>
                                    <textarea
                                        className="w-full p-4 text-stone-900 text-lg leading-relaxed bg-[#f9f9f7] border-0 border-b-2 border-stone-300 focus:border-stone-900 focus:ring-0 focus:bg-yellow-50/30 transition-all min-h-[120px] resize-none placeholder:text-stone-300 placeholder:italic placeholder:font-serif"
                                        placeholder="In conclusion..."
                                        value={essay.conclusion.summary}
                                        onChange={(e) => handleInputChange('conclusion', 'summary', e.target.value)}
                                    />
                                    <VocabularyPill
                                        words={['In conclusion,', 'To sum up,', 'All things considered,']}
                                        onSelect={(word) => handleVocabularyInsert('conclusion', 'summary', word)}
                                    />
                                </div>

                                <div className="space-y-4 pt-4">
                                    <div className="flex justify-between items-end border-b-2 border-stone-900 pb-2">
                                        <div>
                                            <label className="block text-lg font-bold font-serif text-stone-900">2. Final Thought</label>
                                            <p className="text-xs font-mono text-stone-500 uppercase">Look to the future</p>
                                        </div>
                                        <RefineButton section="conclusion" field="finalThought" text={essay.conclusion.finalThought} />
                                    </div>
                                    <textarea
                                        className="w-full p-4 text-stone-900 text-lg leading-relaxed bg-[#f9f9f7] border-0 border-b-2 border-stone-300 focus:border-stone-900 focus:ring-0 focus:bg-yellow-50/30 transition-all min-h-[120px] resize-none placeholder:text-stone-300 placeholder:italic placeholder:font-serif"
                                        placeholder="It is predicted that..."
                                        value={essay.conclusion.finalThought}
                                        onChange={(e) => handleInputChange('conclusion', 'finalThought', e.target.value)}
                                    />
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('learn'); 
            const [currentStep, setCurrentStep] = useState(0);
            const [topic, setTopic] = useState(null);
            const [timer, setTimer] = useState(0);
            const [isTimerRunning, setIsTimerRunning] = useState(false);
            const [showAbout, setShowAbout] = useState(false);
            const [showExaminer, setShowExaminer] = useState(false);
            const [showSettings, setShowSettings] = useState(false);

            const [tourStep, setTourStep] = useState(-1);
            const [hasSeenTour, setHasSeenTour] = useState(false);
            
            const promptRef = useRef(null);

            useEffect(() => {
                if (activeTab === 'practice' && !hasSeenTour) {
                    setTourStep(0);
                    setHasSeenTour(true);
                }
            }, [activeTab]);

            // Auto-resize prompt textarea
            const adjustHeight = () => {
                if (promptRef.current) {
                    promptRef.current.style.height = 'auto';
                    promptRef.current.style.height = promptRef.current.scrollHeight + 'px';
                }
            };

            useEffect(() => {
                if (activeTab === 'practice') {
                    adjustHeight();
                    // Force a recalculation after render paint to handle initial load glitches
                    const timer = setTimeout(adjustHeight, 10);
                    return () => clearTimeout(timer);
                }
            }, [activeTab, topic]);

            const nextTourStep = () => {
                if (tourStep < 5) {
                    setTourStep(tourStep + 1);
                } else {
                    setTourStep(-1);
                }
            };

            const skipTour = () => {
                setTourStep(-1);
            };

            const tourProps = {
                currentStep: tourStep,
                onNext: nextTourStep,
                onSkip: skipTour
            };

            const [essay, setEssay] = useState({
                intro: { paraphrase: '', thesis: '' },
                body1: { topicSentence: '', explanation: '', example: '', concluding: '' },
                body2: { topicSentence: '', explanation: '', example: '', concluding: '' },
                conclusion: { summary: '', finalThought: '' }
            });

            const topics = [
                { id: 1, type: "Opinion", question: "Some people believe that unpaid community service should be a compulsory part of high school programs. To what extent do you agree or disagree?" },
                { id: 2, type: "Discussion", question: "Computers are being used more and more in education. Some say this is positive, while others argue it leads to negative consequences. Discuss both sides." },
                { id: 3, type: "Problem / Solution", question: "In many countries, the gap between the rich and the poor is becoming wider. What are the causes of this problem and what measures can be taken?" },
                { id: 4, type: "Discussion", question: "Some people think that the government should invest more in public services like trains and libraries. Others believe that money should be spent on repairing roads and highways. Discuss both views and give your opinion." },
                { id: 5, type: "Advantage / Disadvantage", question: "In many countries, paying for goods and services using mobile phone apps is becoming increasingly common. Do the advantages of this trend outweigh the disadvantages?" },
                { id: 6, type: "Opinion", question: "The best way to solve the world's environmental problems is to increase the price of fuel. To what extent do you agree or disagree?" },
                { id: 7, type: "Direct Question", question: "Many museums and historical sites are mainly visited by tourists, but not local people. Why is this the case? What can be done to attract more local people?" },
                { id: 8, type: "Opinion", question: "In the future, nobody will buy printed newspapers or books because they will be able to read everything they want online without paying. To what extent do you agree or disagree?" },
                { id: 9, type: "Discussion", question: "Some people think that university students should study whatever they like. Others believe they should only be allowed to study subjects that will be useful in the future, such as science and technology. Discuss both views." },
                { id: 10, type: "Causes / Effects", question: "Nowadays many people choose to be self-employed, rather than to work for a company or organisation. Why is this the case? What could be the disadvantages of being self-employed?" }
            ];

            useEffect(() => {
                setTopic(topics[0]);
            }, []);

            const getNewRandomTopic = () => {
                if (topics.length <= 1) return;
                let newTopic;
                do {
                    newTopic = topics[Math.floor(Math.random() * topics.length)];
                } while (newTopic.id === topic?.id);
                setTopic(newTopic);
            };

            useEffect(() => {
                let interval;
                if (isTimerRunning) {
                    interval = setInterval(() => {
                        setTimer((prev) => prev + 1);
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [isTimerRunning]);

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            };

            const handleInputChange = (section, field, value) => {
                setEssay(prev => ({
                    ...prev,
                    [section]: {
                        ...prev[section],
                        [field]: value
                    }
                }));
            };

            const handleTopicChange = (e) => {
                const newQuestion = e.target.value;
                setTopic(prev => ({ ...prev, question: newQuestion }));
            };

            const generateFullEssay = () => {
                const { intro, body1, body2, conclusion } = essay;
                const text = `${intro.paraphrase} ${intro.thesis}\n\n${body1.topicSentence} ${body1.explanation} ${body1.example} ${body1.concluding}\n\n${body2.topicSentence} ${body2.explanation} ${body2.example} ${body2.concluding}\n\n${conclusion.summary} ${conclusion.finalThought}`;
                return text.replace(/\s+/g, ' ').trim() === '' ? '' : text;
            };

            const calculateWordCount = (text) => {
                return text.trim().split(/\s+/).filter(word => word.length > 0).length;
            };

            const totalWordCount = calculateWordCount(generateFullEssay());

            const copyToClipboard = () => {
                const text = generateFullEssay();
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    const btn = document.getElementById('copyBtn');
                    if (btn) {
                        const originalText = btn.innerHTML;
                        btn.innerHTML = '<span class="uppercase font-black">Copied!</span>';
                        setTimeout(() => btn.innerHTML = originalText, 2000);
                    }
                } catch (err) {
                    console.error('Unable to copy', err);
                }
                document.body.removeChild(textArea);
            };

            // --- Components ---

            const PreviewSection = () => (
                <div className="bg-[#f4f1ea] border-l-2 border-stone-900 h-full flex flex-col overflow-hidden relative">
                    <div className="p-6 flex justify-between items-center z-10 border-b-2 border-stone-900 bg-white">
                        <h3 className="font-black text-stone-900 uppercase tracking-widest flex items-center gap-2 text-sm">
                            Live Preview
                        </h3>
                        <span className={`text-[10px] font-bold px-2 py-1 uppercase border border-stone-900 ${totalWordCount > 300 ? 'bg-red-600 text-white' :
                            totalWordCount >= 200 ? 'bg-green-600 text-white' :
                                'bg-white text-stone-400'
                            }`}>
                            {totalWordCount} words
                        </span>
                    </div>

                    <div className="flex-1 overflow-y-auto p-8 md:p-12 z-10 custom-scrollbar bg-[#f4f1ea]">
                        <div className="bg-[#f4f1ea] min-h-full relative max-w-2xl mx-auto">
                            <div className="font-serif leading-loose text-stone-900 text-lg whitespace-pre-wrap selection:bg-yellow-300 selection:text-stone-900 column-count-1">
                                {generateFullEssay() ? (
                                    <>
                                        <span className="float-left text-7xl font-serif font-black leading-[0.8] pr-3 pt-2">
                                            {generateFullEssay().trim().charAt(0)}
                                        </span>
                                        {generateFullEssay().trim().slice(1)}
                                    </>
                                ) : (
                                    <div className="flex flex-col items-center justify-center h-64 text-stone-300 gap-4 select-none border-2 border-dashed border-stone-300 p-8">
                                        <Type size={48} className="opacity-20" />
                                        <span className="font-serif italic text-xl text-center">The page is blank.<br />The story begins with you.</span>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="p-0 z-20 flex border-t-2 border-stone-900">
                        <button
                            onClick={() => setShowExaminer(true)}
                            disabled={totalWordCount < 50}
                            className="w-1/2 bg-stone-900 text-white py-6 font-black uppercase tracking-widest hover:bg-yellow-400 hover:text-stone-900 transition-colors text-sm border-r-2 border-stone-900 disabled:opacity-50 disabled:hover:bg-stone-900 disabled:hover:text-white"
                        >
                            Get Feedback
                        </button>
                        <button
                            id="copyBtn"
                            onClick={copyToClipboard}
                            className="w-1/2 bg-white text-stone-900 py-6 font-black uppercase tracking-widest hover:bg-stone-900 hover:text-white transition-colors text-sm"
                        >
                            Copy
                        </button>
                    </div>
                    <TourTooltip
                            stepIndex={4}
                            text="Get AI feedback on your writing, or copy it to clipboard."
                            position="top"
                            {...tourProps}
                        />
                </div>
            );

            const LearnCard = ({ title, desc, number }) => (
                <div className="group border-2 border-stone-900 bg-white hover:bg-stone-900 hover:text-white transition-all cursor-default relative overflow-hidden p-6 flex flex-col justify-between min-h-[220px]">
                    <div className="absolute top-4 right-4 text-4xl font-black font-serif text-stone-100 group-hover:text-stone-800 transition-colors z-0">
                        {number}
                    </div>

                    <div className="relative z-10">
                        <h3 className="font-black text-2xl font-serif mb-4 uppercase tracking-tight">{title}</h3>
                        <div className="w-12 h-1 bg-yellow-400 mb-4 group-hover:bg-white transition-colors"></div>
                        <p className="text-sm font-medium leading-relaxed opacity-90">{desc}</p>
                    </div>
                </div>
            );

            return (
                <div className="h-screen bg-[#f4f1ea] text-stone-900 font-sans flex flex-col overflow-hidden selection:bg-yellow-300 selection:text-stone-900">
                    <header className="bg-[#f4f1ea] border-b-2 border-stone-900 px-6 py-5 flex justify-between items-center z-50 sticky top-0">
                        <div className="flex items-center gap-6">
                            <div className="bg-stone-900 text-white w-10 h-10 flex items-center justify-center font-serif font-black text-xl">
                                E
                            </div>
                            <div>
                                <h1 className="text-2xl font-serif font-black tracking-tighter text-stone-900 flex items-center gap-3 leading-none">
                                    ESSAY ARCHITECT
                                    <button
                                        onClick={() => setShowAbout(true)}
                                        className="text-stone-400 hover:text-stone-900 transition-colors"
                                    >
                                        <HelpCircle size={18} />
                                    </button>
                                </h1>
                                <p className="hidden md:block text-[10px] font-bold text-stone-500 tracking-widest uppercase mt-1">Volume 1 â€¢ IELTS & PTE Edition</p>
                            </div>
                        </div>

                        <div className="flex items-center gap-8">
                            <div className="flex items-center">
                                <button
                                    onClick={() => setActiveTab('learn')}
                                    className={`text-sm font-bold uppercase tracking-wider transition-all duration-300 relative mr-4 ${activeTab === 'learn' ? 'text-stone-900 after:content-[""] after:absolute after:-bottom-2 after:left-0 after:w-full after:h-0.5 after:bg-stone-900' : 'text-stone-400 hover:text-stone-600'}`}
                                >
                                    The Guide
                                </button>
                                
                                <div className="w-4 h-8 relative flex flex-col items-center justify-end">
                                    <TourTooltip
                                        stepIndex={0}
                                        text="Switch between The Guide (Theory) and The Editor (Practice)."
                                        position="bottom"
                                        {...tourProps}
                                    />
                                </div>

                                <button
                                    onClick={() => setActiveTab('practice')}
                                    className={`text-sm font-bold uppercase tracking-wider transition-all duration-300 relative ml-4 ${activeTab === 'practice' ? 'text-stone-900 after:content-[""] after:absolute after:-bottom-2 after:left-0 after:w-full after:h-0.5 after:bg-stone-900' : 'text-stone-400 hover:text-stone-600'}`}
                                >
                                    The Editor
                                </button>
                            </div>

                            <div className="flex items-center gap-3 border-l-2 border-stone-300 pl-6 relative">
                                <div className="flex items-center gap-2 text-stone-900">
                                    <Clock size={16} strokeWidth={3} className={isTimerRunning ? 'text-red-500 animate-pulse' : 'text-stone-400'} />
                                    <span className="font-mono font-bold w-[3rem] text-center text-sm">{formatTime(timer)}</span>
                                </div>

                                <div className="flex gap-1">
                                    <button
                                        onClick={() => setIsTimerRunning(!isTimerRunning)}
                                        className={`w-6 h-6 flex items-center justify-center border border-stone-900 hover:bg-stone-900 hover:text-white transition-colors`}
                                        title={isTimerRunning ? "Pause" : "Start"}
                                    >
                                        {isTimerRunning ? (
                                            <div className="flex gap-[2px]">
                                                <div className="w-0.5 h-2 bg-current" />
                                                <div className="w-0.5 h-2 bg-current" />
                                            </div>
                                        ) : (
                                            <div className="w-0 h-0 border-t-[4px] border-t-transparent border-l-[6px] border-l-current border-b-[4px] border-b-transparent ml-0.5" />
                                        )}
                                    </button>

                                    <button
                                        onClick={() => { setIsTimerRunning(false); setTimer(0); }}
                                        className="w-6 h-6 flex items-center justify-center border border-stone-900 text-stone-400 hover:bg-red-500 hover:text-white hover:border-red-500 transition-colors"
                                        title="Reset"
                                    >
                                        <RotateCcw size={10} />
                                    </button>
                                </div>

                                <TourTooltip
                                    stepIndex={2}
                                    text="Time is of the essence. Track it here."
                                    position="bottomLeft"
                                    {...tourProps}
                                />
                            </div>

                            <div className="relative">
                                <button onClick={() => setShowSettings(true)} className="text-stone-400 hover:text-stone-900 transition-colors">
                                    <Settings size={20} />
                                </button>
                                <TourTooltip
                                    stepIndex={5}
                                    text="Configure your API Key here to power the AI features."
                                    position="bottomRight"
                                    {...tourProps}
                                />
                            </div>
                        </div>
                    </header>

                    {showAbout && <AboutModal onClose={() => setShowAbout(false)} />}
                    {showSettings && <SettingsModal onClose={() => setShowSettings(false)} />}
                    {showExaminer && (
                        <ExaminerModal 
                            isOpen={showExaminer} 
                            onClose={() => setShowExaminer(false)} 
                            essayText={generateFullEssay()} 
                        />
                    )}

                    <main className="flex-1 overflow-hidden relative">
                        {activeTab === 'learn' && (
                            <div className="h-full overflow-y-auto custom-scrollbar bg-[#f4f1ea]">
                                <div className="max-w-7xl mx-auto p-12">
                                    <div className="mb-16 border-b-4 border-stone-900 pb-12">
                                        <h2 className="text-7xl md:text-8xl font-black font-serif text-stone-900 mb-6 tracking-tighter leading-[0.8]">
                                            THE <br />
                                            <span className="text-transparent bg-clip-text bg-gradient-to-r from-stone-800 to-stone-600" style={{ WebkitTextStroke: '2px #1c1917' }}>STRUCTURE</span> <br />
                                            ISSUE
                                        </h2>
                                        <p className="text-stone-900 text-xl font-serif max-w-2xl border-l-4 border-yellow-400 pl-6 italic">
                                            Scoring Band 7+ or 79+ isn't about fancy wordsâ€”it's about reliable, rigid structure. Master the 4-paragraph template.
                                        </p>
                                    </div>

                                    <div className="grid md:grid-cols-4 gap-6 mb-16">
                                        <LearnCard
                                            title="Intro"
                                            desc="Paraphrase the question & give your Thesis. Keep it brief. 2-3 sentences max."
                                            number="01"
                                        />
                                        <LearnCard
                                            title="Body"
                                            desc="Two strong paragraphs. Topic Sentence + Explanation + Evidence."
                                            number="02"
                                        />
                                        <LearnCard
                                            title="Link"
                                            desc="Cohesion is key. Use linking words (However, Moreover) to flow."
                                            number="03"
                                        />
                                        <LearnCard
                                            title="End"
                                            desc="Summarize points. Restate opinion. No new ideas. Final thought."
                                            number="04"
                                        />
                                    </div>

                                    <div className="bg-stone-900 text-white p-12 relative overflow-hidden">
                                        <div className="absolute top-0 right-0 p-12 opacity-10">
                                            <Award size={200} />
                                        </div>
                                        <div className="relative z-10 grid md:grid-cols-2 gap-12 items-center">
                                            <div>
                                                <h3 className="font-serif font-black text-4xl mb-4">Ready to draft your first piece?</h3>
                                                <p className="text-stone-400 mb-8 max-w-md">Put the theory into practice with our live editor. Real-time preview, word counting, and structure enforcement included.</p>
                                                <button
                                                    onClick={() => setActiveTab('practice')}
                                                    className="bg-yellow-400 text-stone-900 px-8 py-4 font-black uppercase tracking-widest hover:bg-white transition-colors"
                                                >
                                                    Start Writing
                                                </button>
                                            </div>
                                            <div className="space-y-4">
                                                <div className="border border-stone-700 p-4">
                                                    <span className="text-yellow-400 font-bold uppercase text-xs tracking-wider mb-1 block">Opinion Essays</span>
                                                    <p className="font-serif text-xl">"To what extent do you agree?"</p>
                                                </div>
                                                <div className="border border-stone-700 p-4">
                                                    <span className="text-yellow-400 font-bold uppercase text-xs tracking-wider mb-1 block">Discussion Essays</span>
                                                    <p className="font-serif text-xl">"Discuss both views and give your opinion."</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'practice' && (
                            <div className="flex flex-col md:flex-row h-full">
                                <div className="w-full md:w-3/5 p-0 overflow-y-auto custom-scrollbar bg-[#f4f1ea] border-r-2 border-stone-900">
                                    <div className="p-8 pb-4">
                                        <div className="border-2 border-stone-900 bg-white p-6 relative shadow-[8px_8px_0px_0px_rgba(28,25,23,0.1)] hover:shadow-[8px_8px_0px_0px_rgba(28,25,23,1)] transition-shadow duration-300">
                                            <div className="flex justify-between items-start mb-4 border-b border-stone-200 pb-4">
                                                <span className="text-[10px] font-black text-stone-900 uppercase tracking-widest flex items-center gap-2">
                                                    <span className="w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></span>
                                                    Topic: {topic?.type}
                                                </span>
                                                <div className="relative z-20">
                                                    <button
                                                        onClick={getNewRandomTopic}
                                                        className="text-stone-400 hover:text-stone-900 transition-colors flex items-center gap-1 text-xs font-bold uppercase tracking-wider"
                                                        title="Get new random topic"
                                                    >
                                                        <RefreshCw size={12} /> New Prompt
                                                    </button>
                                                    <TourTooltip
                                                        stepIndex={1}
                                                        text="This is your prompt. Auto-resizes as you type. Click 'New Prompt' to shuffle."
                                                        position="bottomLeft"
                                                        {...tourProps}
                                                    />
                                                </div>
                                            </div>
                                            <div className="relative group">
                                                <textarea
                                                    ref={promptRef}
                                                    className={`w-full text-stone-900 font-serif font-bold leading-tight bg-transparent border-0 p-0 resize-none outline-none placeholder:text-stone-300 overflow-hidden ${
                                                        (topic?.question?.length || 0) > 150 ? 'text-xs' : (topic?.question?.length || 0) > 80 ? 'text-sm' : 'text-lg'
                                                    }`}
                                                    value={topic?.question || ''}
                                                    onChange={handleTopicChange}
                                                    rows={1}
                                                    placeholder="Type your essay question here..."
                                                />
                                                <div className="absolute right-0 bottom-0 pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <PenTool size={14} className="text-stone-300" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="pb-20 md:pb-0 min-h-[500px] p-8 pt-0">
                                        <StepWizard
                                            currentStep={currentStep}
                                            setCurrentStep={setCurrentStep}
                                            essay={essay}
                                            handleInputChange={handleInputChange}
                                            tourProps={tourProps}
                                            topic={topic}
                                        />
                                    </div>
                                </div>

                                <div className="w-full md:w-2/5 h-80 md:h-auto border-t-2 md:border-t-0 border-stone-900 relative z-10 bg-white">
                                    <PreviewSection />
                                </div>
                            </div>
                        )}
                    </main>

                    <footer className="bg-[#f4f1ea] border-t-2 border-stone-900 py-2 text-center shrink-0 z-50">
                        <p className="text-[10px] font-bold uppercase tracking-widest text-stone-500">
                            Architected by <a href="https://github.com/scuba3198" target="_blank" rel="noopener noreferrer" className="text-stone-900 font-black border-b-2 border-yellow-400 hover:bg-yellow-400 transition-colors cursor-pointer">Mumukshu D.C.</a>
                        </p>
                    </footer>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>